# This is for local dev (e.g. laptop) development
# Simplified - runs on localhost, no Docker networks needed
services:
  v-db-juniper010726:
    image: postgres:16-alpine
    container_name: v-db-juniper010726
    env_file:
      - ./v-db-juniper010726/.env.local.db.example
    ports:
      - "5432:5432"
    volumes:
      # Bind mounts - directories from the host mapped into the container
      - ./v-db-juniper010726/pg-data-vendure-juniper:/var/lib/postgresql/data

  v-srv-juniper010726:
    build:
      context: ./my-shop-juniper/apps/server
      dockerfile: Dockerfile.server
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    ports:
      - 3000:3000
      - 5173:5173
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/server:/usr/src/app # bind mount
      # Prevent overwriting node_modules and build artifacts from container
      # - /usr/src/app/node_modules # anonymous volume
      # - /usr/src/app/dist         # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      - server-node-modules:/usr/src/app/node_modules  # ← Named
      - server-dist:/usr/src/app/dist                   # ← Named
    env_file:
      - ./my-shop-juniper/apps/server/.env

  v-wrk-juniper010726:
    build:
      context: ./my-shop-juniper/apps/server
      dockerfile: Dockerfile.worker
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    # No ports exposed - worker only processes background jobs via job queue (accessed from DB rather than backend server)
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/server:/usr/src/app
      # Prevent overwriting node_modules and build artifacts from container
      # - /usr/src/app/node_modules  # anonymous volume
      # - /usr/src/app/dist            # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      - worker-node-modules:/usr/src/app/node_modules  # ← Named
      - worker-dist:/usr/src/app/dist                   # ← Named
    env_file:
      - ./my-shop-juniper/apps/server/.env

  v-storefront-juniper010726:
    build:
      context: ./my-shop-juniper/apps/storefront
      dockerfile: Dockerfile.storefront
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    ports:
      - 3001:3001  # Storefront accessible at localhost:3001
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/storefront:/app # bind mount
      # Prevent overwriting node_modules and build artifacts from container
      # - /app/node_modules # anonymous volume
      # - /app/.next        # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      - storefront-node-modules:/app/node_modules  # ← Named volume
      - storefront-next:/app/.next                 # ← Named volume
    env_file:
      - ./my-shop-juniper/apps/storefront/.env.local.storefront.example

volumes:
  storefront-node-modules:
  storefront-next:
  server-node-modules:
  server-dist:
  worker-node-modules:
  worker-dist: