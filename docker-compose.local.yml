# This is for local dev (e.g. laptop) development
# Simplified - runs on localhost, using the implicit bridge network
services:
  vendure-db:
    image: postgres:17
    env_file:
      - ./vendure-db/.env.local.db.example
    ports:
      - "5432:5432"
    volumes:
      # Bind mounts - directories from the host mapped into the container
      - ./vendure-db/pg-data:/var/lib/postgresql/data
    networks:
      - vendure-network

  vendure-server:
    depends_on:
      - vendure-db
    build:
      context: ./my-shop-juniper/apps/server
      dockerfile: Dockerfile.server
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    ports:
      - 3000:3000
      - 5173:5173
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/server:/usr/src/app # bind mount
      # Prevent overwriting node_modules and build artifacts from container
      # - /usr/src/app/node_modules # anonymous volume
      # - /usr/src/app/dist         # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      ############
      # - server-node-modules:/usr/src/app/node_modules # ← Named
      # - server-dist:/usr/src/app/dist # ← Named
    env_file:
      # vendure-config expects it to be ".env" so leaving it as that for simplicity. Just know, this is just an unsecure, local, example .env file.
      # for the default prod env vars, check .github/defaults/env-defaults.yml -- it contains the env vars used to build the docker image with. and the secure prod env vars are stored in the github repo secrets
      - ./my-shop-juniper/apps/server/.env
    networks:
      - vendure-network

  vendure-worker:
    depends_on:
      - vendure-db
    build:
      context: ./my-shop-juniper/apps/server
      dockerfile: Dockerfile.worker
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    # No ports exposed - worker only processes background jobs via job queue (accessed from DB rather than backend server)
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/server:/usr/src/app
      # Prevent overwriting node_modules and build artifacts from container
      # - /usr/src/app/node_modules  # anonymous volume
      # - /usr/src/app/dist            # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      ############
      # - worker-node-modules:/usr/src/app/node_modules # ← Named
      # - worker-dist:/usr/src/app/dist # ← Named
    env_file:
      # vendure-config expects it to be ".env" so leaving it as that for simplicity. Just know, this is just an unsecure, local, example .env file.
      # for the default prod env vars, check .github/defaults/env-defaults.yml -- it contains the env vars used to build the docker image with. and the secure prod env vars are stored in the github repo secrets
      - ./my-shop-juniper/apps/server/.env
    networks:
      - vendure-network

  vendure-storefront:
    depends_on:
      - vendure-db
      - vendure-server
      - vendure-worker
    build:
      context: ./my-shop-juniper/apps/storefront
      dockerfile: Dockerfile.storefront
      target: dev # runs dev stage in its Dockerfile-- which includes CMD. Prod stage will be run via CICD
    ports:
      - 3001:3001 # Storefront accessible at localhost:3001
    volumes:
      # Mount source code for hot reload
      - ./my-shop-juniper/apps/storefront:/app # bind mount
      # Prevent overwriting node_modules and build artifacts from container
      # - /app/node_modules # anonymous volume
      # - /app/.next        # anonymous volume
      # going with named volumes instead of anonymous volumes.  The anon volumes should have overriden the bind mount for their paths, but they aren't always reliable
      ############
      # - storefront-node-modules:/app/node_modules # ← Named volume
      # - storefront-next:/app/.next # ← Named volume
    env_file:
      - ./my-shop-juniper/apps/storefront/.env.local.storefront.example
    networks:
      - vendure-network

# volumes:
# storefront-node-modules:
# storefront-next:
# server-node-modules:
# server-dist:
# worker-node-modules:
# worker-dist:

networks:
  vendure-network:
    driver: bridge
