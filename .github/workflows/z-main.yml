# .github/workflows/main.yml
name: Vendure Deployment Pipeline

on:
  push:
    # branches: [blah] # uncomment for when dont want to run CICD on commit to main
    branches: [main]

permissions:
  contents: read
  actions: write

jobs:
  # Database setup/check
  database:
    uses: ./.github/workflows/db-init.yml
    permissions:
      contents: read
    secrets:
      LINUX_SSH_PRIVATE_KEY_CICD: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
      LINUX_BOTCICDGHA_USERNAME: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
      LINUX_SERVER_IPADDRESS: ${{ secrets.LINUX_SERVER_IPADDRESS }}
      POSTGRES__SECRET_ENV_FILE: ${{ secrets.POSTGRES__SECRET_ENV_FILE }}

  # Server deployment (depends on DB)
  server:
    needs: database
    uses: ./.github/workflows/vendure-server-deploy.yml
    permissions:
      contents: write
      actions: write
    secrets:
      LINUX_SSH_PRIVATE_KEY_CICD: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
      LINUX_BOTCICDGHA_USERNAME: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
      LINUX_SERVER_IPADDRESS: ${{ secrets.LINUX_SERVER_IPADDRESS }}
      GHPAT_AS_CICD_SECRET: ${{ secrets.GHPATCICD_VendureRepo_010726 }}
      SRV_WRK__SECRET_ENV_FILE: ${{ secrets.SRV_WRK__SECRET_ENV_FILE }}

  # # Worker deployment (depends on Server)
  # worker:
  #   needs: server
  #   uses: ./.github/workflows/vendure-worker-deploy.yml
  #   permissions:
  #     contents: write
  #     actions: write
  #   secrets:
  #     LINUX_SSH_PRIVATE_KEY_CICD: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
  #     LINUX_BOTCICDGHA_USERNAME: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
  #     LINUX_SERVER_IPADDRESS: ${{ secrets.LINUX_SERVER_IPADDRESS }}
  #     GHPAT_AS_CICD_SECRET: ${{ secrets.GHPATCICD_VendureRepo_010726 }}
  #     SRV_WRK__SECRET_ENV_FILE: ${{ secrets.SRV_WRK__SECRET_ENV_FILE }}

  # # Storefront deployment (depends on Worker)
  # storefront:
  #   needs: worker
  #   uses: ./.github/workflows/vendure-storefront-deploy.yml
  #   permissions:
  #     contents: write
  #     actions: write
  #   secrets:
  #     LINUX_SSH_PRIVATE_KEY_CICD: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
  #     LINUX_BOTCICDGHA_USERNAME: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
  #     LINUX_SERVER_IPADDRESS: ${{ secrets.LINUX_SERVER_IPADDRESS }}
  #     GHPAT_AS_CICD_SECRET: ${{ secrets.GHPATCICD_VendureRepo_010726 }}
  #     STOREFRONT__SECRET_ENV_FILE: ${{ secrets.STOREFRONT__SECRET_ENV_FILE }}

  # Deployment summary
  summary:
    needs: [database, server] # storefront, server, worker]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download deployment markers
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: '*-last-deployed-commit'
          path: ./deployment-markers
          merge-multiple: true

      - name: Create Deployment Summary
        run: |
          # Current commit info
          CURRENT_COMMIT=$(git rev-parse HEAD)
          CURRENT_COMMIT_SHORT=$(git rev-parse --short HEAD)
          CURRENT_COMMIT_DATE=$(git show -s --format=%ci $CURRENT_COMMIT)
          CURRENT_COMMIT_MESSAGE=$(git show -s --format=%s $CURRENT_COMMIT)

          echo "# ðŸ“Š Deployment Summary - Commit ${CURRENT_COMMIT_SHORT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${CURRENT_COMMIT_SHORT}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Date** | ${CURRENT_COMMIT_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Message** | ${CURRENT_COMMIT_MESSAGE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Database
          echo "## ðŸ’¾ Database (vendure-db-juniper010726)" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.database.outputs.db_needs_deploy }}" == "true" ]]; then
            echo "âœ… **Created** - Database container was newly created" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Exists** - Database container already present" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Server
          echo "## ðŸ–¥ï¸ Server (vendure-server-juniper010726)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "./deployment-markers/server-last-commit.txt" ]; then
            LAST_COMMIT=$(cat ./deployment-markers/server-last-commit.txt)
            LAST_SHORT=$(git rev-parse --short $LAST_COMMIT)
            LAST_DATE=$(git show -s --format=%ci $LAST_COMMIT)
            CHANGES=$(git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/server | wc -l)
          else
            LAST_SHORT="N/A"
            LAST_DATE="First deployment"
            CHANGES="N/A"
          fi
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Last deployed** | \`${LAST_SHORT}\` (${LAST_DATE}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Changes detected** | ${{ needs.server.outputs.had_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Files changed** | ${CHANGES} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action taken** | ${{ needs.server.outputs.action_taken }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.server.outputs.had_changes }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            if [ -f "./deployment-markers/server-last-commit.txt" ]; then
              git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/server >> $GITHUB_STEP_SUMMARY
            else
              echo "First deployment - all files are new" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

        # # Worker
        # echo "## âš™ï¸ Worker (vendure-worker-juniper010726)" >> $GITHUB_STEP_SUMMARY
        
        # if [ -f "./deployment-markers/worker-last-commit.txt" ]; then
        #   LAST_COMMIT=$(cat ./deployment-markers/worker-last-commit.txt)
        #   LAST_SHORT=$(git rev-parse --short $LAST_COMMIT)
        #   LAST_DATE=$(git show -s --format=%ci $LAST_COMMIT)
        #   CHANGES=$(git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/server | wc -l)
        # else
        #   LAST_SHORT="N/A"
        #   LAST_DATE="First deployment"
        #   CHANGES="N/A"
        # fi
        
        # echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        # echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        # echo "| **Last deployed** | \`${LAST_SHORT}\` (${LAST_DATE}) |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Changes detected** | ${{ needs.worker.outputs.had_changes }} |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Files changed** | ${CHANGES} |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Action taken** | ${{ needs.worker.outputs.action_taken }} |" >> $GITHUB_STEP_SUMMARY
        
        # if [[ "${{ needs.worker.outputs.had_changes }}" == "true" ]]; then
        #   echo "" >> $GITHUB_STEP_SUMMARY
        #   echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
        #   echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        #   if [ -f "./deployment-markers/worker-last-commit.txt" ]; then
        #     git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/server >> $GITHUB_STEP_SUMMARY
        #   else
        #     echo "First deployment - all files are new" >> $GITHUB_STEP_SUMMARY
        #   fi
        #   echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        # fi
        # echo "" >> $GITHUB_STEP_SUMMARY

        # # Storefront
        # echo "## ðŸŒ Storefront (vendure-storefront-juniper010726)" >> $GITHUB_STEP_SUMMARY
        
        # if [ -f "./deployment-markers/storefront-last-commit.txt" ]; then
        #   LAST_COMMIT=$(cat ./deployment-markers/storefront-last-commit.txt)
        #   LAST_SHORT=$(git rev-parse --short $LAST_COMMIT)
        #   LAST_DATE=$(git show -s --format=%ci $LAST_COMMIT)
        #   CHANGES=$(git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/storefront | wc -l)
        # else
        #   LAST_SHORT="N/A"
        #   LAST_DATE="First deployment"
        #   CHANGES="N/A"
        # fi
        
        # echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        # echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        # echo "| **Last deployed** | \`${LAST_SHORT}\` (${LAST_DATE}) |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Changes detected** | ${{ needs.storefront.outputs.had_changes }} |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Files changed** | ${CHANGES} |" >> $GITHUB_STEP_SUMMARY
        # echo "| **Action taken** | ${{ needs.storefront.outputs.action_taken }} |" >> $GITHUB_STEP_SUMMARY
        
        # if [[ "${{ needs.storefront.outputs.had_changes }}" == "true" ]]; then
        #   echo "" >> $GITHUB_STEP_SUMMARY
        #   echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
        #   echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        #   if [ -f "./deployment-markers/storefront-last-commit.txt" ]; then
        #     git diff --name-only $LAST_COMMIT $CURRENT_COMMIT -- ./my-shop-juniper/apps/storefront >> $GITHUB_STEP_SUMMARY
        #   else
        #     echo "First deployment - all files are new" >> $GITHUB_STEP_SUMMARY
        #   fi
        #   echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        # fi
        # echo "" >> $GITHUB_STEP_SUMMARY