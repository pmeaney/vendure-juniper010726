# .github/workflows/db-init.yml
# Purpose:
# The intention is to only deploy the database once-- When the server is first setup.
# After that, we don't want to mess with it:
# So, if it exists-- Just move on.
# If it doesn't exist, create it.

name: Database Init

on:
  workflow_call:
    secrets:
      LINUX_SSH_PRIVATE_KEY_CICD:
        required: true
      LINUX_BOTCICDGHA_USERNAME:
        required: true
      LINUX_SERVER_IPADDRESS:
        required: true
      POSTGRES__SECRET_ENV_FILE:
        required: true
    outputs:
      db_needs_deploy:
        description: "Whether DB was deployed"
        value: ${{ jobs.check-db.outputs.db_needs_deploy }}

jobs:
  check-db:
    runs-on: ubuntu-latest
    outputs:
      db_needs_deploy: ${{ steps.check.outputs.db_needs_deploy }}

    steps:
      - uses: actions/checkout@v4

      - name: Check if DB exists
        id: check
        env:
          SSH_KEY: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
          SSH_USER: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
          SERVER_IP: ${{ secrets.LINUX_SERVER_IPADDRESS }}
        run: |
          # Debug environment variables
          echo "Debug - Checking if variables are set:"
          echo "SSH_USER is set: $(if [ -n "$SSH_USER" ]; then echo "YES"; else echo "NO"; fi)"
          echo "SERVER_IP is set: $(if [ -n "$SERVER_IP" ]; then echo "YES"; else echo "NO"; fi)"

          # Setup SSH
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cat >>~/.ssh/config <<END
          Host prod
            HostName $SERVER_IP
            User $SSH_USER
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
          END

          # Check if container exists
          CONTAINER_EXISTS=$(ssh prod "docker ps -a --format '{{.Names}}' | grep -q '^vendure-db-juniper010726$' && echo 'true' || echo 'false'")

          if [ "$CONTAINER_EXISTS" = "false" ]; then
            echo "⚠️ Database container not found, will create it"
            echo "db_needs_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "✅ Database container exists"
            echo "db_needs_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy DB container
        if: steps.check.outputs.db_needs_deploy == 'true'
        env:
          SSH_KEY: ${{ secrets.LINUX_SSH_PRIVATE_KEY_CICD }}
          SSH_USER: ${{ secrets.LINUX_BOTCICDGHA_USERNAME }}
          SERVER_IP: ${{ secrets.LINUX_SERVER_IPADDRESS }}
          POSTGRES_ENV: ${{ secrets.POSTGRES__SECRET_ENV_FILE }}
        run: |
          # Debug environment variables
          echo "Debug - Checking if variables are set:"
          echo "SSH_USER is set: $(if [ -n "$SSH_USER" ]; then echo "YES"; else echo "NO"; fi)"
          echo "SERVER_IP is set: $(if [ -n "$SERVER_IP" ]; then echo "YES"; else echo "NO"; fi)"

          # Setup SSH
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cat >>~/.ssh/config <<END
          Host prod
            HostName $SERVER_IP
            User $SSH_USER
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
          END

          # Create directory on remote server for the temporary prod env file
          ssh prod "mkdir -p ~/vendure-db-juniper010726"

          # Create the temporary prod env file directly on the remote server
          # Echo the env var content with proper quoting for multiline preservation
          ssh prod "echo '$POSTGRES_ENV' > ~/vendure-db-juniper010726/postgres-env-prod.env"

          # Debug: Verify env file was created and show contents
          echo "=== Verifying environment file on remote server ==="
          ssh prod "ls -la ~/vendure-db-juniper010726/ && echo '--- Postgres env file contents ---' && cat ~/vendure-db-juniper010726/postgres-env-prod.env"

          # Create Docker network if it doesn't exist
          ssh prod "docker network ls --filter name=vendure-network -q | grep -q . || docker network create vendure-network"

          # Create volume if it doesn't exist
          ssh prod "docker volume inspect vendure-db-juniper010726-data >/dev/null 2>&1 || docker volume create vendure-db-juniper010726-data"

          # Run the container on the remote server
          ssh prod "\
          docker run -d \
            --name vendure-db-juniper010726 \
            --network vendure-network \
            --network-alias vendure-database \
            --env-file ~/vendure-db-juniper010726/postgres-env-prod.env \
            -p 5432:5432 \
            -v vendure-db-juniper010726-data:/var/lib/postgresql/data \
            postgres:17"

          # Cleanup env file
          ssh prod "rm ~/vendure-db-juniper010726/postgres-env-prod.env"

          # Verify the container is running in a separate command
          CONTAINER_STATUS=$(ssh prod "docker ps -f name=vendure-db-juniper010726 --format '{{.Status}}'")
          if [ -n "$CONTAINER_STATUS" ]; then
            echo "✅ Database container successfully created and running"
            echo "DB_CREATED=true" >> $GITHUB_ENV
          else
            echo "❌ Failed to create database container"
            echo "=== Container logs ==="
            ssh prod "docker logs vendure-db-juniper010726"
            exit 1
          fi

      # Final status output
      - name: Status Report
        run: |
          if [[ "${{ steps.check.outputs.db_needs_deploy }}" == "false" ]]; then
            echo "Database container already existed"
          elif [[ "$DB_CREATED" == "true" ]]; then
            echo "Database container was created successfully"
          else
            echo "Failed to verify database status"
          fi